rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // 1. CÁC HÀM TIỆN ÍCH (HELPER FUNCTIONS)
    // =========================================================

    // Kiểm tra đã đăng nhập chưa
    function isSignedIn() {
      return request.auth != null;
    }

    // Lấy thông tin user hiện tại từ DB
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Kiểm tra Role (Giúp code gọn hơn)
    function isRole(role) {
      return isSignedIn() && getUserData().role == role;
    }

    function isAdmin() { return isRole('ADMIN'); }
    function isCS() { return isRole('CS'); }
    function isDS() { return isRole('DS'); }
    
    // Admin hoặc CS (Nhóm quản lý)
    function isManager() {
      return isAdmin() || isCS();
    }

    // Kiểm tra xem user có phải là người đang làm đơn này không
    function isMyTask(resourceData) {
      return resourceData.designerId == request.auth.uid;
    }

    // Kiểm tra các trường bị thay đổi (QUAN TRỌNG: Chống sửa đề bài)
    function onlyUpdating(allowedFields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
    }

    // =========================================================
    // 2. RULES CHO COLLECTION 'users'
    // =========================================================
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create, update: if isAdmin() || request.auth.uid == userId;
      allow delete: if isAdmin();
    }

    // =========================================================
    // 3. RULES CHO COLLECTION 'tasks' (ĐÃ ĐỔI TÊN TỪ ORDERS)
    // =========================================================
    match /tasks/{taskId} {

      // --- QUYỀN ĐỌC (READ) ---
      // Quản lý xem hết. 
      // DS xem đơn mới (để nhận) HOẶC đơn của chính mình đang làm/sửa.
      allow read: if isManager() || 
                  (isDS() && (resource.data.status == 'new' || isMyTask(resource.data)));

      // --- QUYỀN TẠO (CREATE) ---
      // Chỉ quản lý được tạo đơn.
      // Validate dữ liệu đầu vào cơ bản.
      allow create: if isManager() && 
                    request.resource.data.status == 'new' &&
                    request.resource.data.title.size() > 0;

      // --- QUYỀN SỬA (UPDATE) ---
      
      // 1. Quản lý (CS/Admin): Sửa được mọi thứ.
      allow update: if isManager();

      // 2. Designer (DS): Sửa có điều kiện cực chặt
      allow update: if isDS() && (
        
        // KỊCH BẢN A: CLAIM (Nhận việc)
        // Yêu cầu: status 'new' -> 'doing', gán uid cho mình
        (resource.data.status == 'new' && 
         request.resource.data.status == 'doing' &&
         request.resource.data.designerId == request.auth.uid &&
         onlyUpdating(['status', 'designerId', 'updatedAt']))
        
        || 

        // KỊCH BẢN B: SUBMIT (Nộp bài) hoặc RE-SUBMIT (Sửa lỗi)
        // Yêu cầu: status 'doing'/'need_fix' -> 'in_review', chỉ sửa designFiles
        ((resource.data.status == 'doing' || resource.data.status == 'need_fix') &&
         request.resource.data.status == 'in_review' &&
         isMyTask(resource.data) &&
         onlyUpdating(['status', 'designFiles', 'updatedAt']))

        ||

        // KỊCH BẢN C: GIVE BACK (Trả đơn)
        // Yêu cầu: status 'doing' -> 'new', hủy gán uid
        (resource.data.status == 'doing' &&
         request.resource.data.status == 'new' &&
         isMyTask(resource.data) &&
         request.resource.data.designerId == null &&
         onlyUpdating(['status', 'designerId', 'updatedAt']))
      );

      // --- QUYỀN XÓA (DELETE) ---
      // Chỉ Admin được xóa.
      allow delete: if isAdmin() || isCS();
      // Subcollection LOGS
      match /logs/{logId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
      }
    }

    // =========================================================
    // 4. RULES CHO LOGS (LỊCH SỬ)
    // =========================================================
    match /logs/{logId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.actorId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // =========================================================
    // 5. RULES CHO CẤU HÌNH HỆ THỐNG (SETTINGS)
    // =========================================================
    match /settings/{docId} {
      allow read, write: if isAdmin();
    }
  }
}
