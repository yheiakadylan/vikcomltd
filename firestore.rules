rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // 1. HELPER FUNCTIONS
    // =========================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getRole() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
        ? getUserData().role 
        : null;
    }

    function isAdmin() { 
      return isSignedIn() && getRole() == 'ADMIN'; 
    }
    
    function isCS() { 
      return isSignedIn() && getRole() == 'CS'; 
    }
    
    function isDS() { 
      return isSignedIn() && getRole() == 'DS'; 
    }
    
    function isManager() {
      return isAdmin() || isCS();
    }

    function isMyTask(resourceData) {
      return resourceData.designerId == request.auth.uid;
    }

    function onlyUpdating(allowedFields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
    }

    // =========================================================
    // 2. USERS COLLECTION
    // =========================================================
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isAdmin() || request.auth.uid == userId;
      allow delete: if isAdmin();
    }

    // =========================================================
    // 3. TASKS COLLECTION (MAIN COLLECTION)
    // =========================================================
    match /tasks/{taskId} {

      // --- READ ---
      allow read: if isSignedIn() && (
        isManager() || 
        (isDS() && (resource.data.status == 'new' || isMyTask(resource.data)))
      );

      // --- CREATE ---
      // Allow CS/ADMIN to create.
      allow create: if isSignedIn() && isManager();

      // --- UPDATE ---
      
      // Managers can update anything
      allow update: if isSignedIn() && isManager();

      // Upload Context: Allow Managers OR Owner to update files
      allow update: if isSignedIn() && 
        (isManager() || isMyTask(resource.data)) &&
        onlyUpdating(['mockupUrl', 'customerFiles', 'designFiles', 'updatedAt']);

      // DS: Claim task
      allow update: if isSignedIn() && isDS() && 
        resource.data.status == 'new' && 
        request.resource.data.status == 'doing' &&
        request.resource.data.designerId == request.auth.uid &&
        onlyUpdating(['status', 'designerId', 'updatedAt']);
      
      // DS: Submit work
      allow update: if isSignedIn() && isDS() && 
        (resource.data.status == 'doing' || resource.data.status == 'need_fix') &&
        request.resource.data.status == 'in_review' &&
        isMyTask(resource.data) &&
        onlyUpdating(['status', 'designFiles', 'updatedAt']);

      // DS: Give back task
      allow update: if isSignedIn() && isDS() && 
        resource.data.status == 'doing' &&
        request.resource.data.status == 'new' &&
        isMyTask(resource.data) &&
        request.resource.data.designerId == null &&
        onlyUpdating(['status', 'designerId', 'updatedAt']);

      // --- DELETE ---
      allow delete: if isSignedIn() && isManager();

      // --- LOGS SUBCOLLECTION ---
      match /logs/{logId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
      }
    }

    // =========================================================
    // 4. LOGS COLLECTION (GLOBAL)
    // =========================================================
    match /logs/{logId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.actorId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // =========================================================
    // 5. SETTINGS COLLECTION
    // =========================================================
    match /settings/{docId} {
      allow read: if isSignedIn();
      allow create, delete: if isAdmin();
      allow update: if isSignedIn() && isAdmin();
    }
  }
}
